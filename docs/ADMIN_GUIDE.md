# 管理员功能使用指南

## 📋 目录

- [创建管理员账号](#创建管理员账号)
- [管理员后台](#管理员后台)
- [用户管理](#用户管理)
- [视频管理](#视频管理)
- [权限说明](#权限说明)

## 🔐 创建管理员账号

### 方法 1: 使用脚本创建（推荐）

在项目根目录运行：

```bash
npm run create-admin
```

然后按提示输入：
```
邮箱: admin@example.com
密码: admin123456
用户名: 管理员
```

脚本会：
- 如果邮箱已存在，将该用户升级为管理员
- 如果邮箱不存在，创建新的管理员账号

### 方法 2: 手动创建

使用 Prisma Studio：

```bash
npm run db:studio
```

1. 打开 http://localhost:5555
2. 选择 `User` 表
3. 创建或编辑用户
4. 将 `role` 字段设置为 `admin`
5. 保存

### 方法 3: 数据库直接操作

如果你有数据库访问权限：

```sql
-- 创建新管理员
INSERT INTO "User" (id, email, name, password, role) VALUES
('admin_id', 'admin@example.com', '管理员', '$hashed_password', 'admin');

-- 或将现有用户升级为管理员
UPDATE "User" SET role = 'admin' WHERE email = 'user@example.com';
```

## 🏠 管理员后台

### 访问后台

登录后，导航栏会显示"管理后台"入口（紫色）。

或直接访问：
```
http://localhost:3000/admin
```

### 后台首页功能

**统计信息：**
- 总用户数
- 总视频数
- 管理员数量
- 最近7天新增

**快速操作：**
- 用户管理
- 视频管理

## 👥 用户管理

### 访问用户管理

```
http://localhost:3000/admin/users
```

或从管理后台首页点击"用户管理"。

### 功能列表

#### 1. 查看用户列表

显示所有用户信息：
- 用户名和邮箱
- 角色（管理员/普通用户）
- 上传视频数量
- 注册时间

#### 2. 修改用户角色

直接在列表中选择角色：
- **管理员** - 拥有所有权限
- **普通用户** - 只能管理自己的视频

**限制：**
- 不能修改自己的角色（防止锁死）

#### 3. 删除用户

点击"删除"按钮删除用户。

**注意：**
- 不能删除自己
- 删除用户会级联删除其所有视频
- 操作不可撤销，请谨慎

#### 4. 分页浏览

- 每页显示 20 个用户
- 支持翻页

## 🎬 视频管理

### 管理员权限

管理员对所有视频拥有以下权限：

#### 1. 查看所有视频

- 在视频列表页可以看到所有用户的视频
- 包括其他用户上传的视频

#### 2. 编辑任意视频

访问任意视频详情页，可以看到"编辑视频"按钮。

编辑功能：
- 修改标题
- 修改描述
- 修改 M3U8 链接
- 修改或提取封面

#### 3. 删除任意视频

- 在视频详情页或列表页可以删除任意视频
- 即使不是自己上传的

#### 4. 批量操作（待开发）

未来计划功能：
- 批量删除
- 批量移动
- 批量编辑标签

## 🔒 权限说明

### 权限级别

#### 管理员 (admin)

**拥有权限：**
- ✅ 访问管理后台
- ✅ 查看所有用户
- ✅ 修改用户角色
- ✅ 删除用户
- ✅ 查看统计信息
- ✅ 编辑任意视频
- ✅ 删除任意视频
- ✅ 所有普通用户权限

**限制：**
- ❌ 不能修改自己的角色
- ❌ 不能删除自己

#### 普通用户 (user)

**拥有权限：**
- ✅ 上传视频
- ✅ 编辑自己的视频
- ✅ 删除自己的视频
- ✅ 查看所有视频
- ✅ 播放视频

**限制：**
- ❌ 不能访问管理后台
- ❌ 不能管理其他用户
- ❌ 不能编辑他人视频
- ❌ 不能删除他人视频

### 权限检查机制

**前端检查：**
```typescript
import { hasAdminAccess, canEditVideo } from '@/lib/permissions'

// 检查是否是管理员
if (hasAdminAccess(user)) {
  // 显示管理员功能
}

// 检查是否可以编辑视频
if (canEditVideo(user, video.userId)) {
  // 显示编辑按钮
}
```

**后端检查：**
```typescript
// 所有管理员 API 都会检查权限
if (!hasAdminAccess(session.user)) {
  return NextResponse.json({ error: '无权限' }, { status: 403 })
}
```

## 📊 管理员常用操作

### 场景 1: 新用户注册后升级为管理员

```bash
npm run create-admin
# 输入已存在的邮箱
```

### 场景 2: 删除违规视频

1. 访问视频详情页
2. 点击"删除视频"按钮
3. 确认删除

### 场景 3: 批量修改用户角色

1. 访问用户管理页
2. 逐个选择用户角色下拉框
3. 选择新角色（自动保存）

### 场景 4: 查看系统统计

访问管理后台首页：
```
http://localhost:3000/admin
```

查看：
- 用户增长趋势
- 视频上传趋势
- 系统活跃度

### 场景 5: 编辑用户视频

1. 访问任意视频详情页
2. 点击"编辑视频"按钮（管理员可见）
3. 修改信息并保存

## 🛡️ 安全建议

### 1. 管理员账号安全

- ✅ 使用强密码（至少12位）
- ✅ 不要共享管理员账号
- ✅ 定期更换密码
- ✅ 限制管理员数量

### 2. 权限分配

- ✅ 谨慎授予管理员权限
- ✅ 只给可信任的用户
- ✅ 定期审查管理员列表
- ✅ 及时撤销离职人员权限

### 3. 操作审计（待开发）

未来计划：
- 记录所有管理员操作
- 敏感操作邮件通知
- 操作日志查询

### 4. 防护措施

**已实现：**
- ✅ 不能修改自己的角色
- ✅ 不能删除自己
- ✅ API 双重权限验证
- ✅ 敏感操作二次确认

## 📝 API 接口

### 管理员 API

**获取统计信息：**
```
GET /api/admin/stats
```

**获取用户列表：**
```
GET /api/admin/users?page=1&limit=20
```

**更新用户信息：**
```
PUT /api/admin/users/:id
Body: { role: "admin" }
```

**删除用户：**
```
DELETE /api/admin/users/:id
```

## 🐛 常见问题

### Q1: 忘记管理员密码？

**解决：**
```bash
npm run create-admin
# 输入同样的邮箱，会升级为管理员
```

然后在数据库中重置密码。

### Q2: 管理后台入口不显示？

**检查：**
1. 确认已登录
2. 确认角色是 `admin`
3. 刷新页面

### Q3: 无法访问管理后台？

**可能原因：**
- 账号不是管理员
- 会话过期，需重新登录

**解决：**
```bash
npm run create-admin
```

### Q4: 删除用户失败？

**可能原因：**
- 试图删除自己
- 数据库连接问题

### Q5: 无法修改其他用户视频？

**检查：**
- 确认是管理员角色
- 检查浏览器控制台错误

## 🔮 未来功能

计划中的管理员功能：

- [ ] 操作日志
- [ ] 数据导出
- [ ] 批量操作
- [ ] 统计图表
- [ ] 内容审核
- [ ] 系统设置
- [ ] 备份恢复
- [ ] 邮件通知

## 📚 相关文档

- [项目说明](../README.md)
- [API 文档](./API.md)
- [权限系统](../lib/permissions.ts)

## 🎯 最佳实践

1. **定期备份数据库**
2. **限制管理员数量**（建议1-3个）
3. **使用强密码**
4. **监控异常操作**
5. **定期审查用户列表**

---

**问题反馈**: 查看 [TROUBLESHOOTING.md](../TROUBLESHOOTING.md) 或提交 Issue。
