version: '3.8'

services:
  # Next.js 应用
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # 传递构建时需要的环境变量
        DATABASE_URL: ${DATABASE_URL}
    container_name: m3u8_app
    restart: unless-stopped
    network_mode: host
    environment:
      # 数据库连接 - 使用外部 PostgreSQL
      DATABASE_URL: ${DATABASE_URL}
      # NextAuth 配置
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:${APP_PORT:-3000}}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-this-to-a-random-secret-in-production}
      # Node 环境
      NODE_ENV: production
      # 应用端口
      PORT: 3000
    command: >
      sh -c "
        npx prisma db push &&
        npx prisma db seed &&
        node server.js
      "
